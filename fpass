#!/usr/bin/env bash
# =============================================================================
# fpass — convenient wrapper around Cloudflare's gokey password generator
# Copyright (c) 2025 Heesang Whang
#
# Licensed under the MIT License (Expat). See the LICENSE file in this repository.
#
# This script depends on:
#   • gokey     — Copyright (c) 2016 Cloudflare, Inc.
#                 Licensed under the 3-clause BSD license.
#                 See LICENSE-gokey.txt for the full text.
# =============================================================================

set -euo pipefail

# Colors for output (disabled if not a terminal)
if [[ -t 1 ]]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[0;33m'
    NC='\033[0m' # No Color
else
    RED=''
    GREEN=''
    YELLOW=''
    NC=''
fi

log_error() { echo -e "${RED}✗ $1${NC}" >&2; }
log_success() { echo -e "${GREEN}✓ $1${NC}"; }
log_warn() { echo -e "${YELLOW}⚠ $1${NC}" >&2; }

usage() {
    cat <<EOF
Usage: $(basename "$0") [OPTIONS] [REALM]

Generate a password using gokey and copy it to clipboard.

Options:
    -l LENGTH   Password length (default: gokey default)
    -v          Verbose mode (enable bash tracing)
    -h          Show this help message

Arguments:
    REALM       The realm/identifier for the password (prompted if not provided)

Configuration:
    Requires gokey configuration in ~/.gokey/ with:
      - master-password file
      - seedfile

Dependencies:
    - gokey: https://github.com/cloudflare/gokey
EOF
}

copy_to_clipboard() {
    local content="$1"

    if command -v pbcopy &>/dev/null; then
        echo -n "$content" | pbcopy
    elif command -v xclip &>/dev/null; then
        echo -n "$content" | xclip -selection clipboard
    elif command -v wl-copy &>/dev/null; then
        echo -n "$content" | wl-copy
    elif command -v clip &>/dev/null; then
        echo -n "$content" | clip
    else
        log_error "No clipboard utility found (pbcopy, xclip, wl-copy, or clip)"
        return 1
    fi
}

check_command() {
    local cmd="$1"
    local url="$2"

    if ! command -v "$cmd" &>/dev/null; then
        log_error "$cmd is not installed or not in PATH."
        echo "Refer to: $url" >&2
        return 1
    fi
}

check_file() {
    local file="$1"
    local description="$2"

    if [[ ! -f "$file" ]]; then
        log_error "$description not found at $file"
        echo "Please initialize gokey first." >&2
        return 1
    fi

    if [[ ! -r "$file" ]]; then
        log_error "$description at $file is not readable"
        return 1
    fi
}

check_directory() {
    local dir="$1"
    local description="$2"

    if [[ ! -d "$dir" ]]; then
        log_error "$description not found at $dir"
        echo "Please initialize gokey first." >&2
        return 1
    fi
}

# Check dependencies
check_dependencies() {
    local has_errors=0

    check_command "gokey" "https://github.com/cloudflare/gokey" || has_errors=1

    return $has_errors
}

# Check configuration files
check_config() {
    local config_dir="${GOKEY_CONF_DIR:-$HOME/.gokey}"
    local has_errors=0

    check_directory "$config_dir" "gokey configuration directory" || has_errors=1

    if [[ $has_errors -eq 0 ]]; then
        check_file "$config_dir/master-password" "Master password file" || has_errors=1
        check_file "$config_dir/seedfile" "Seed file" || has_errors=1
    fi

    return $has_errors
}

main() {
    local realm=""
    local length=""
    local verbose=0

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--help)
                usage
                exit 0
                ;;
            -v|--verbose)
                verbose=1
                shift
                ;;
            -l|--length)
                if [[ -z "${2:-}" ]]; then
                    log_error "Option -l requires an argument"
                    exit 1
                fi
                if ! [[ "$2" =~ ^[0-9]+$ ]]; then
                    log_error "Length must be a positive integer"
                    exit 1
                fi
                length="$2"
                shift 2
                ;;
            -*)
                log_error "Unknown option: $1"
                echo "Use -h for help" >&2
                exit 1
                ;;
            *)
                if [[ -n "$realm" ]]; then
                    log_error "Multiple realms specified: '$realm' and '$1'"
                    exit 1
                fi
                realm="$1"
                shift
                ;;
        esac
    done

    # Enable verbose mode after parsing (so we don't trace arg parsing)
    if [[ $verbose -eq 1 ]]; then
        set -x
    fi

    # Check dependencies and configuration
    check_dependencies || exit 1
    check_config || exit 1

    # Prompt user to enter realm if not provided
    if [[ -z "$realm" ]]; then
        if [[ -t 0 ]]; then
            read -rp "Enter realm: " realm
        else
            log_error "Realm not provided and stdin is not a terminal"
            exit 1
        fi
    fi

    # Validate realm
    realm="${realm#"${realm%%[![:space:]]*}"}"  # trim leading whitespace
    realm="${realm%"${realm##*[![:space:]]}"}"  # trim trailing whitespace

    if [[ -z "$realm" ]]; then
        log_error "Realm cannot be empty"
        exit 1
    fi

    # Build gokey command
    local config_dir="${GOKEY_CONF_DIR:-$HOME/.gokey}"
    local gokey_cmd=(
        gokey
        -P "$config_dir/master-password"
        -s "$config_dir/seedfile"
        -r "$realm"
        -t pass
    )

    if [[ -n "$length" ]]; then
        gokey_cmd+=(-l "$length")
    fi

    # Run gokey and copy output to clipboard
    if "${gokey_cmd[@]}" | copy_to_clipboard; then
        log_success "Key generated and copied to clipboard for realm: $realm"
    else
        log_error "Failed to generate or copy key"
        exit 1
    fi
}

main "$@"
